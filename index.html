<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor RGD | Clúster Energético NL</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; }
        #map { height: 100%; width: 100%; }
        
        /* Popup styling Mapbox */
        .mapboxgl-popup { max-width: 400px !important; z-index: 50; }
        .mapboxgl-popup-content { padding: 0; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2); }
        .mapboxgl-popup-close-button { color: #64748b; font-size: 16px; padding: 4px 8px; z-index: 10; outline: none; }
        
        /* Patrón rayado */
        .bg-striped {
            background-image: linear-gradient(45deg, rgba(255,255,255,0.5) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.5) 50%, rgba(255,255,255,0.5) 75%, transparent 75%, transparent 100%);
            background-size: 8px 8px;
        }

        /* Loader */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }
        .spinner {
            border: 4px solid #e2e8f0; border-top: 4px solid #3b82f6; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100">

    <div id="loader">
        <div class="spinner mb-4"></div>
        <h2 class="text-slate-600 font-bold text-xs tracking-widest animate-pulse">CONECTANDO CON SERVIDOR DE MAPAS...</h2>
    </div>

    <div class="absolute top-4 left-4 z-50 flex flex-col gap-3 max-w-xs pointer-events-none">
        <div class="bg-white/95 backdrop-blur shadow-lg rounded-xl p-4 border border-slate-200 pointer-events-auto">
            <h1 class="font-bold text-slate-800 text-xl leading-tight tracking-tight">Monitor RGD</h1>
            <p class="text-xs text-slate-500 mt-1 font-medium">Capacidad de Alojamiento (Media Tensión)</p>
        </div>

        <div class="bg-white/95 backdrop-blur shadow-lg rounded-xl p-3 border border-slate-200 pointer-events-auto">
            <div class="flex justify-between items-center mb-2">
                <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Filtrar por Tensión</h4>
                <button onclick="resetFilters()" class="text-[10px] text-blue-500 hover:text-blue-700 font-medium cursor-pointer">Ver Todos</button>
            </div>
            <div id="voltageButtons" class="flex flex-wrap gap-2">
                <span class="text-xs text-slate-400">Sincronizando...</span>
            </div>
        </div>
    </div>

    <div class="absolute top-4 right-4 z-50 flex flex-col gap-2 pointer-events-auto">
        <button onclick="resetView()" class="bg-white p-2.5 rounded-lg shadow-md border border-slate-200 hover:bg-slate-50 transition-all text-slate-600" title="Centrar Mapa">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
        </button>
        <button onclick="toggleStyle()" class="bg-white p-2.5 rounded-lg shadow-md border border-slate-200 hover:bg-slate-50 transition-all text-slate-600" title="Cambiar Mapa Base">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>
        </button>
    </div>

    <div class="absolute bottom-8 right-4 z-50 bg-white/95 backdrop-blur shadow-lg rounded-xl p-4 border border-slate-200 text-sm pointer-events-auto">
        <h4 class="font-bold text-slate-700 mb-3 text-xs uppercase tracking-wide border-b pb-2 border-slate-100">Disponibilidad Real</h4>
        <div class="space-y-2.5">
            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span><span class="text-slate-600 text-xs">Alta (> 2 MW)</span></div>
            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-orange-500 mr-2"></span><span class="text-slate-600 text-xs">Media (0.5 - 2 MW)</span></div>
            <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span><span class="text-slate-600 text-xs">Saturada (< 0.5 MW)</span></div>
        </div>
        <div class="mt-4 pt-2 border-t border-slate-100">
            <h4 class="font-bold text-slate-700 mb-2 text-[10px] uppercase tracking-wide">Capacidad Técnica</h4>
            <div class="flex flex-col gap-2 text-xs text-slate-500">
                <div class="flex items-center"><div class="w-8 h-0.5 bg-slate-400 mr-2"></div><span>≤ 30 kV (Ej. 13.8)</span></div>
                <div class="flex items-center"><div class="w-8 h-1.5 bg-slate-400 mr-2"></div><span>> 30 kV (Ej. 34.5)</span></div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // ==============================================================
        // CREDENCIALES INSERTADAS
        // ==============================================================
        
        mapboxgl.accessToken = 'pk.eyJ1IjoiYWx2YXJvcm9tb2ciLCJhIjoiY21pN3BzNGhnMDNpMTJsb3B5em5hMm0xbCJ9.Tyod9cc_1gd8SYk7Sp1Vpw';

        const MY_TILESET_ID = 'alvaroromog.2m3q9i17'; 
        
        // NOTA: Si no ves las líneas, verifica este nombre en Mapbox Studio -> Tileset
        const SOURCE_LAYER_NAME = 'RGD_NUEVO_LEON_19_11_2025-3iqk49'; 

        // ==============================================================

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11', 
            center: [-100.3161, 25.6866],
            zoom: 10,
            hash: true
        });

        map.addControl(new mapboxgl.NavigationControl(), 'top-right');

        // Variables de filtros
        var activeVoltages = new Set();
        var allVoltages = [13.8, 23, 34.5]; 

        map.on('load', () => {
            
            // Agregar Fuente Mapbox
            map.addSource('rgd-source', {
                type: 'vector',
                url: 'mapbox://' + MY_TILESET_ID
            });

            // Agregar Capa Visual
            map.addLayer({
                'id': 'rgd-lines',
                'type': 'line',
                'source': 'rgd-source',
                'source-layer': SOURCE_LAYER_NAME,
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    // Color por disponibilidad
                    'line-color': [
                        'case',
                        ['>', ['to-number', ['get', 'MWCapDispo']], 2.0], '#22c55e',
                        ['>=', ['to-number', ['get', 'MWCapDispo']], 0.5], '#f97316',
                        '#ef4444'
                    ],
                    // Grosor por tensión
                    'line-width': [
                        'case',
                        ['>', ['to-number', ['get', 'kVTension']], 30], 4.5,
                        2.5
                    ],
                    'line-opacity': 0.8
                }
            });

            // Quitar loader cuando cargue
            document.getElementById('loader').style.opacity = '0';
            
            // Generar filtros dinámicos
            setTimeout(() => {
                generateFilters();
            }, 2000);
        });

        // --- POPUP INTERACTIVO ---
        map.on('click', 'rgd-lines', (e) => {
            const props = e.features[0].properties;
            
            const parseNumber = (val) => {
                const n = parseFloat(val);
                return isNaN(n) ? 0 : n;
            };

            const instaladaMW = parseNumber(props.MWCapInsta);
            const disponibleMW = parseNumber(props.MWCapDispo);
            const limiteKW = parseNumber(props.kWLimiteCR);
            const limiteRegulatorioMW = limiteKW / 1000;

            const habilitadaMW = instaladaMW + disponibleMW;
            let deficitMW = limiteRegulatorioMW - habilitadaMW;
            if (deficitMW < 0) deficitMW = 0;

            let totalBase = limiteRegulatorioMW > 0 ? limiteRegulatorioMW : habilitadaMW;
            if (totalBase === 0) totalBase = 1;

            let pctInstalada = (instaladaMW / totalBase) * 100;
            let pctDisponible = (disponibleMW / totalBase) * 100;
            let pctDeficit = (deficitMW / totalBase) * 100;
            if (pctInstalada > 0 && pctInstalada < 2) pctInstalada = 2;

            const circuito = props.circuito || 'Desconocido';
            const textoStatus = disponibleMW > 0.5 ? 'DISPONIBLE' : 'SATURADO';
            const bgStatus = disponibleMW > 0.5 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';

            const popupContent = `
                <div class="font-sans text-slate-800 text-sm w-full">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-start">
                        <div>
                            <div class="text-[10px] text-slate-400 uppercase font-bold">Circuito</div>
                            <div class="font-bold text-slate-800 leading-tight text-base">${circuito}</div>
                        </div>
                        <div class="text-right">
                            <span class="text-[9px] font-bold px-2 py-1 rounded ${bgStatus}">${textoStatus}</span>
                            <div class="text-[9px] text-slate-400 mt-1">${props.kVTension} kV</div>
                        </div>
                    </div>

                    <div class="p-4 space-y-4">
                        <div class="grid grid-cols-3 gap-2">
                            <div class="bg-blue-50 p-2 rounded-lg border border-blue-100 text-center flex flex-col justify-center">
                                <div class="text-[8px] text-blue-500 uppercase font-bold tracking-wide leading-tight mb-1">Alojado</div>
                                <div class="text-sm font-bold text-blue-700 leading-none">${instaladaMW.toFixed(2)}<span class="text-[9px] font-normal ml-0.5">MW</span></div>
                            </div>
                            <div class="bg-green-50 p-2 rounded-lg border border-green-100 text-center flex flex-col justify-center">
                                <div class="text-[8px] text-green-600 uppercase font-bold tracking-wide leading-tight mb-1">Disponible</div>
                                <div class="text-sm font-bold text-green-700 leading-none">${disponibleMW.toFixed(2)}<span class="text-[9px] font-normal ml-0.5">MW</span></div>
                            </div>
                            <div class="bg-indigo-50 p-2 rounded-lg border border-indigo-100 text-center flex flex-col justify-center">
                                <div class="text-[8px] text-indigo-500 uppercase font-bold tracking-wide leading-tight mb-1">Total Real</div>
                                <div class="text-sm font-bold text-indigo-700 leading-none">${habilitadaMW.toFixed(2)}<span class="text-[9px] font-normal ml-0.5">MW</span></div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between text-[10px] text-slate-400 mb-1 uppercase tracking-wide">
                                <span>Composición Total</span>
                            </div>
                            <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden flex border border-slate-200 shadow-inner">
                                <div class="h-full bg-blue-500" style="width: ${pctInstalada}%" title="Alojado"></div>
                                <div class="h-full bg-green-500" style="width: ${pctDisponible}%" title="Disponible"></div>
                                <div class="h-full bg-slate-200 bg-striped border-l border-white/50" style="width: ${pctDeficit}%" title="Restringido"></div>
                            </div>
                        </div>

                        <div class="pt-2 border-t border-slate-100 flex justify-between items-center text-[10px] text-slate-400">
                            <span class="uppercase font-semibold text-slate-500">Límite por Tensión:</span>
                            <strong class="text-slate-600 text-xs">${limiteRegulatorioMW.toFixed(2)} MW</strong>
                        </div>
                    </div>
                </div>
            `;

            new mapboxgl.Popup({ closeButton: false, maxWidth: '400px' })
                .setLngLat(e.lngLat)
                .setHTML(popupContent)
                .addTo(map);
        });

        map.on('mouseenter', 'rgd-lines', () => { map.getCanvas().style.cursor = 'pointer'; });
        map.on('mouseleave', 'rgd-lines', () => { map.getCanvas().style.cursor = ''; });


        // --- FILTROS DINÁMICOS ---

        function generateFilters() {
            // Consultamos features cargados para ver voltajes reales
            const features = map.querySourceFeatures('rgd-source', { sourceLayer: SOURCE_LAYER_NAME });
            const voltages = new Set();
            features.forEach(f => {
                if (f.properties.kVTension) voltages.add(parseFloat(f.properties.kVTension));
            });

            const btnContainer = document.getElementById('voltageButtons');
            btnContainer.innerHTML = '';
            
            const list = voltages.size > 0 ? Array.from(voltages).sort((a,b)=>a-b) : [13.8, 23, 34.5];
            allVoltages = list;
            activeVoltages = new Set(list);

            list.forEach(v => {
                var btn = document.createElement('button');
                btn.className = "px-3 py-1 rounded-full text-[10px] font-bold uppercase bg-blue-100 text-blue-700 border border-blue-200 hover:bg-blue-200 transition-all";
                btn.innerText = v + ' kV';
                btn.onclick = function() { toggleVoltage(v, btn); };
                btnContainer.appendChild(btn);
            });
        }

        function toggleVoltage(val, btn) {
            if (activeVoltages.has(val)) {
                activeVoltages.delete(val);
                btn.className = "px-3 py-1 rounded-full text-[10px] font-bold uppercase bg-slate-100 text-slate-400 border border-slate-200 hover:bg-slate-200 transition-all";
            } else {
                activeVoltages.add(val);
                btn.className = "px-3 py-1 rounded-full text-[10px] font-bold uppercase bg-blue-100 text-blue-700 border border-blue-200 hover:bg-blue-200 transition-all";
            }
            applyFilters();
        }

        function resetFilters() {
            activeVoltages = new Set(allVoltages);
            document.querySelectorAll('#voltageButtons button').forEach(btn => {
                btn.className = "px-3 py-1 rounded-full text-[10px] font-bold uppercase bg-blue-100 text-blue-700 border border-blue-200 hover:bg-blue-200 transition-all";
            });
            applyFilters();
        }

        function applyFilters() {
            const filter = ['in', ['to-number', ['get', 'kVTension']], ...Array.from(activeVoltages)];
            map.setFilter('rgd-lines', filter);
        }

        function resetView() {
            map.flyTo({ center: [-100.3161, 25.6866], zoom: 10 });
        }

        // --- TOGGLE STYLE (Light/Dark) ---
        let isLight = true;
        function toggleStyle() {
            isLight = !isLight;
            const style = isLight ? 'mapbox://styles/mapbox/light-v11' : 'mapbox://styles/mapbox/navigation-night-v1';
            map.setStyle(style);
            
            // Re-agregar capa al cambiar estilo
            map.once('style.load', () => {
                if (!map.getSource('rgd-source')) {
                    map.addSource('rgd-source', { type: 'vector', url: 'mapbox://' + MY_TILESET_ID });
                }
                map.addLayer({
                    'id': 'rgd-lines',
                    'type': 'line',
                    'source': 'rgd-source',
                    'source-layer': SOURCE_LAYER_NAME,
                    'layout': { 'line-join': 'round', 'line-cap': 'round' },
                    'paint': {
                        'line-color': [
                            'case',
                            ['>', ['to-number', ['get', 'MWCapDispo']], 2.0], isLight ? '#22c55e' : '#4ade80',
                            ['>=', ['to-number', ['get', 'MWCapDispo']], 0.5], isLight ? '#f97316' : '#fb923c',
                            isLight ? '#ef4444' : '#f87171'
                        ],
                        'line-width': [
                            'case', ['>', ['to-number', ['get', 'kVTension']], 30], 4.5, 2.5
                        ],
                        'line-opacity': isLight ? 0.8 : 0.95
                    }
                });
            });
        }

    </script>
</body>

</html>
